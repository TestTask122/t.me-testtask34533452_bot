<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Aesthetic XO</title>
    <style>
        body { background: #FAF7F6; font-family: sans-serif; transition: all 0.5s; }
        .cell { height: 90px; display: flex; align-items: center; justify-content: center; font-size: 2rem; border-radius: 1rem; background: #FFF; cursor: pointer; transition: 0.2s; }
        .cell:active { transform: scale(0.95); }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen text-[#5A4B48]">

    <div id="game" class="w-full max-w-xs px-4">
        <h1 class="text-center text-xl tracking-widest uppercase font-light mb-8">Tic Tac Toe</h1>
        
        <div id="board" class="grid grid-cols-3 gap-3"></div>

        <div id="result" class="hidden mt-8 text-center animate-fade-in">
            <div id="promo-box" class="hidden bg-white p-4 rounded-2xl shadow-sm border border-rose-100 mb-4">
                <p class="text-xs uppercase opacity-50">Ваш промокод</p>
                <p id="promo-code" class="text-2xl font-bold text-[#C28E82]"></p>
            </div>
            <p id="status-text" class="mb-4 text-lg"></p>
            <button onclick="reset()" class="w-full py-3 bg-[#C28E82] text-white rounded-full shadow-lg">Играть еще раз</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // Развернуть на весь экран

        const BOT_TOKEN = 'ВАШ_ТОКЕН_БОТА';
        const user = tg.initDataUnsafe?.user; // Получаем данные игрока автоматически
        
        let board = Array(9).fill(null);
        let active = true;

        async function notify(text) {
            if (!user?.id) return;
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: user.id, text: text })
            });
        }

        function check() {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let [a,b,c] of wins) if(board[a] && board[a]===board[b] && board[a]===board[c]) return board[a];
            return board.includes(null) ? null : 'draw';
        }

        function render() {
            const container = document.getElementById('board');
            container.innerHTML = '';
            board.forEach((val, i) => {
                const el = document.createElement('div');
                el.className = 'cell shadow-sm';
                el.style.color = val === '✕' ? '#C28E82' : '#D1D1D1';
                el.innerText = val || '';
                el.onclick = () => move(i);
                container.appendChild(el);
            });
        }

        function move(i) {
            if (!active || board[i]) return;
            board[i] = '✕';
            render();
            if (!end()) setTimeout(ai, 500);
        }

        function ai() {
            const empty = board.map((v, i) => v === null ? i : null).filter(v => v !== null);
            if (empty.length) {
                board[empty[Math.floor(Math.random() * empty.length)]] = '○';
                render();
                end();
            }
        }

        function end() {
            const res = check();
            if (!res) return false;
            active = false;
            const status = document.getElementById('result');
            const promoBox = document.getElementById('promo-box');
            status.classList.remove('hidden');

            if (res === '✕') {
                const code = Math.floor(10000 + Math.random() * 90000);
                document.getElementById('promo-code').innerText = code;
                document.getElementById('status-text').innerText = 'Вы победили!';
                promoBox.classList.remove('hidden');
                notify(`Победа! Промокод выдан: ${code}`);
            } else {
                document.getElementById('status-text').innerText = res === 'draw' ? 'Ничья' : 'Попробуйте снова';
                if (res === '○') notify('Проигрыш');
            }
            return true;
        }

        function reset() {
            board = Array(9).fill(null);
            active = true;
            document.getElementById('result').classList.add('hidden');
            render();
        }

        render();
    </script>
</body>
</html>