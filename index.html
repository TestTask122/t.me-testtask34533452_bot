<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Tic Tac Toe</title>
    <style>
        body { background: #FAF7F6; font-family: 'Segoe UI', sans-serif; }
        .cell { height: 100px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; border-radius: 1.5rem; background: #FFF; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(243, 225, 222, 0.5); }
        .cell:active { transform: scale(0.95); }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen text-[#5A4B48] p-6">

    <div class="w-full max-w-xs">
        <h1 class="text-center text-sm tracking-[0.3em] uppercase opacity-40 mb-10">Luxury XO</h1>
        
        <div id="board" class="grid grid-cols-3 gap-4"></div>

        <!-- Экран результата -->
        <div id="result" class="hidden mt-10 text-center">
            <!-- Блок для победы (Промокод) -->
            <div id="win-screen" class="hidden">
                <div class="bg-white p-6 rounded-[2rem] border border-rose-100 shadow-xl mb-6">
                    <p class="text-[10px] uppercase tracking-widest opacity-60 mb-2">Ваш приз</p>
                    <p id="promo-code" class="text-4xl font-light text-[#C28E82] tracking-tighter"></p>
                </div>
            </div>

            <!-- Блок для проигрыша -->
            <div id="loss-screen" class="hidden mb-6">
                <p class="text-lg italic opacity-70">Не расстраивайтесь...</p>
            </div>

            <p id="status-message" class="text-lg mb-6"></p>
            
            <!-- Кнопка "Сыграть еще раз" (показывается всегда в конце) -->
            <button onclick="reset()" class="w-full py-4 bg-[#C28E82] text-white rounded-full shadow-lg hover:bg-[#AD7D72] transition-all uppercase text-xs tracking-widest font-bold">
                Сыграть ещё раз
            </button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const BOT_TOKEN = 'ВАШ_ТОКЕН_БОТА'; // ВСТАВЬ ТОКЕН СЮДА
        const userId = tg.initDataUnsafe?.user?.id;
        
        let board = Array(9).fill(null);
        let active = true;

        async function sendTg(text) {
            if (!userId || !BOT_TOKEN || BOT_TOKEN.includes('ВАШ')) return;
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: userId, text: text })
            });
        }

        function check() {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let [a,b,c] of wins) if(board[a] && board[a]===board[b] && board[a]===board[c]) return board[a];
            return board.includes(null) ? null : 'draw';
        }

        function render() {
            const container = document.getElementById('board');
            container.innerHTML = '';
            board.forEach((val, i) => {
                const el = document.createElement('div');
                el.className = 'cell';
                el.style.color = val === '✕' ? '#C28E82' : '#D1D1D1';
                el.innerText = val || '';
                el.onclick = () => move(i);
                container.appendChild(el);
            });
        }

        function move(i) {
            if (!active || board[i]) return;
            board[i] = '✕';
            render();
            const res = check();
            if (res) endGame(res);
            else setTimeout(ai, 500);
        }

        function ai() {
            const empty = board.map((v, i) => v === null ? i : null).filter(v => v !== null);
            if (empty.length && active) {
                board[empty[Math.floor(Math.random() * empty.length)]] = '○';
                render();
                const res = check();
                if (res) endGame(res);
            }
        }

        function endGame(res) {
            active = false;
            const resultDiv = document.getElementById('result');
            const winScreen = document.getElementById('win-screen');
            const lossScreen = document.getElementById('loss-screen');
            
            resultDiv.classList.remove('hidden');

            if (res === '✕') {
                // ПОБЕДА
                const code = Math.floor(10000 + Math.random() * 90000);
                document.getElementById('promo-code').innerText = code;
                winScreen.classList.remove('hidden');
                sendTg(`Победа! Промокод выдан: ${code}`);
            } else if (res === '○') {
                // ПРОИГРЫШ
                lossScreen.classList.remove('hidden');
                document.getElementById('status-message').innerText = 'Предлагаем сыграть ещё раз?';
                sendTg(`Проигрыш`);
            } else {
                // НИЧЬЯ
                document.getElementById('status-message').innerText = 'Ничья. Попробуем снова?';
            }
        }

        function reset() {
            board = Array(9).fill(null);
            active = true;
            document.getElementById('result').classList.add('hidden');
            document.getElementById('win-screen').classList.add('hidden');
            document.getElementById('loss-screen').classList.add('hidden');
            document.getElementById('status-message').innerText = '';
            render();
        }

        render();
    </script>
</body>
</html>
